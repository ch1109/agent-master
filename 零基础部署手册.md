# Agent Master 零基础部署操作手册

> 📖 本手册专为**完全没有编程基础**的人编写，只要按照步骤一步一步操作，就能成功部署！

---

## 📋 目录

1. [部署前准备](#部署前准备)
2. [首次部署完整流程](#首次部署完整流程)
3. [日常更新部署](#日常更新部署)
4. [服务管理](#服务管理)
5. [常见问题解决](#常见问题解决)

---

## 部署前准备

### 需要准备的信息

请确认你有以下信息（这些信息在本次部署中已确定）：

```
✅ 服务器地址：192.168.100.62
✅ 用户名：hywl
✅ 密码：123
✅ 项目位置：/Users/chch/Desktop/agent master
```

### 需要的工具

- **终端（Terminal）**：Mac 电脑自带，在"启动台 → 其他 → 终端"
- **浏览器**：用来访问部署好的网站

---

## 首次部署完整流程

### 🎯 概述

首次部署分为两大步骤：
1. **服务器初始化**（只需要做一次）
2. **部署项目文件**（以后更新也用这个）

---

## 第一部分：服务器初始化（仅首次需要）

### 步骤 1：打开终端

1. 在 Mac 上按 **⌘ + 空格键**
2. 输入 `终端` 或 `terminal`
3. 按回车打开

### 步骤 2：上传初始化脚本到服务器

**操作说明**：复制下面的整段命令，粘贴到终端，然后按回车。

```bash
cd "/Users/chch/Desktop/agent master" && expect << 'EOF'
spawn scp scripts/server/setup.sh hywl@192.168.100.62:~/
expect "password:"
send "123\r"
expect eof
EOF
```

**预期结果**：
```
setup.sh                    100%    显示上传进度
```

如果看到 `100%`，说明上传成功！✅

---

### 步骤 3：连接到服务器并执行初始化

**操作说明**：复制下面的命令，粘贴到终端，然后按回车。

```bash
expect << 'EOF'
spawn ssh hywl@192.168.100.62
expect "password:"
send "123\r"
expect "hywl@"
send "chmod +x ~/setup.sh && ~/setup.sh\r"
expect {
    "hywl@" {
        send "exit\r"
    }
    timeout {
        send "exit\r"
    }
}
expect eof
EOF
```

**这个命令做什么**：
1. 自动登录到服务器（密码：123）
2. 运行初始化脚本
3. 安装必要的软件（PM2 和 serve）
4. 创建文件夹
5. 完成后自动退出

**预期结果**：
```
✓ PM2 安装成功
✓ serve 安装成功
✓ 目录结构创建成功
✓ PM2 配置文件已生成
```

如果看到这些 ✓，说明初始化成功！✅

**⚠️ 重要提示**：如果看到需要执行的 sudo 命令提示，先记下来，等脚本执行完后再处理。

---

### 步骤 4：配置开机自启（可选）

**什么时候需要**：如果步骤 3 的结果中出现了类似这样的提示：

```
需要执行以下命令配置开机自启：
sudo env PATH=...
```

**怎么做**：
1. SSH 连接到服务器：
   ```bash
   ssh hywl@192.168.100.62
   ```
   输入密码：`123`

2. 复制步骤 3 中提示的完整 `sudo` 命令，粘贴执行

3. 执行：
   ```bash
   pm2 save
   ```

4. 退出服务器：
   ```bash
   exit
   ```

---

## 第二部分：部署项目到服务器

### 步骤 5：构建项目

**操作说明**：在终端执行以下命令

```bash
cd "/Users/chch/Desktop/agent master" && npm run build
```

**这个命令做什么**：
- 将项目源代码编译成可以在浏览器运行的文件
- 生成的文件放在 `dist` 文件夹中

**需要等待时间**：3-5 分钟

**预期结果**：
```
✓ built in 3.04s
```

如果看到 `built` 和绿色的 ✓，说明构建成功！✅

---

### 步骤 6：打包文件

**操作说明**：

```bash
cd "/Users/chch/Desktop/agent master" && tar -czf dist.tgz -C dist .
```

**这个命令做什么**：
- 把 `dist` 文件夹压缩成一个 `dist.tgz` 文件
- 方便上传到服务器

**预期结果**：
- 命令执行完毕，没有报错

---

### 步骤 7：上传到服务器

**操作说明**：

```bash
expect << 'EOF'
spawn scp dist.tgz hywl@192.168.100.62:/tmp/
expect "password:"
send "123\r"
expect eof
EOF
```

**这个命令做什么**：
- 把 `dist.tgz` 上传到服务器的 `/tmp/` 文件夹

**预期结果**：
```
dist.tgz                    100%    显示上传速度
```

如果看到 `100%`，说明上传成功！✅

---

### 步骤 8：在服务器上部署

**操作说明**：复制下面的**完整命令块**，一次性粘贴到终端执行

```bash
expect << 'EOF'
spawn ssh hywl@192.168.100.62
expect "password:"
send "123\r"
expect "hywl@"

send "cd ~/apps/agent-master\r"
expect "hywl@"

send "TIMESTAMP=\$(date +%Y%m%d_%H%M%S)\r"
expect "hywl@"

send "mkdir -p releases/\$TIMESTAMP\r"
expect "hywl@"

send "tar -xzf /tmp/dist.tgz -C releases/\$TIMESTAMP/\r"
expect "hywl@"

send "rm -f current\r"
expect "hywl@"

send "ln -s releases/\$TIMESTAMP current\r"
expect "hywl@"

send "pm2 restart agent-master || pm2 start serve --name agent-master -- current -s\r"
expect "hywl@"

send "pm2 save\r"
expect "hywl@"

send "sleep 3 && pm2 status\r"
expect "hywl@"

send "exit\r"
expect eof
EOF
```

**这个命令做什么**：
1. 自动登录到服务器
2. 创建新的版本文件夹
3. 解压上传的文件
4. 切换到新版本
5. 重启服务（或启动服务）
6. 保存 PM2 配置
7. 显示服务状态
8. 自动退出

**预期结果**：
```
┌────┬──────────────┬─────────┬────────┬───────────┐
│ id │ name         │ mode    │ status │ ...       │
├────┼──────────────┼─────────┼────────┼───────────┤
│ 0  │ agent-master │ fork    │ online │ ...       │
└────┴──────────────┴─────────┴────────┴───────────┘
```

如果看到 `status` 显示 **online**，说明服务启动成功！✅

---

### 步骤 9：验证部署

**操作说明**：打开浏览器，访问以下地址

```
http://192.168.100.62:3000
```

**预期结果**：
- 能看到 Agent Master 的后台管理界面
- 页面正常显示，没有报错

**如果看到了正常页面**：🎉 **恭喜！部署成功！**

---

## 日常更新部署

当你修改了代码，需要重新部署时，执行以下步骤：

### 🔄 快速部署（3 步搞定）

#### 第 1 步：构建和打包

```bash
cd "/Users/chch/Desktop/agent master" && npm run build && tar -czf dist.tgz -C dist .
```

**等待时间**：3-5 分钟

---

#### 第 2 步：上传到服务器

```bash
expect << 'EOF'
spawn scp dist.tgz hywl@192.168.100.62:/tmp/
expect "password:"
send "123\r"
expect eof
EOF
```

**等待时间**：5-10 秒

---

#### 第 3 步：部署并重启

```bash
expect << 'EOF'
spawn ssh hywl@192.168.100.62
expect "password:"
send "123\r"
expect "hywl@"

send "cd ~/apps/agent-master\r"
expect "hywl@"

send "TIMESTAMP=\$(date +%Y%m%d_%H%M%S)\r"
expect "hywl@"

send "mkdir -p releases/\$TIMESTAMP\r"
expect "hywl@"

send "tar -xzf /tmp/dist.tgz -C releases/\$TIMESTAMP/\r"
expect "hywl@"

send "rm -f current\r"
expect "hywl@"

send "ln -s releases/\$TIMESTAMP current\r"
expect "hywl@"

send "pm2 restart agent-master\r"
expect "hywl@"

send "pm2 save\r"
expect "hywl@"

send "exit\r"
expect eof
EOF
```

---

#### 第 4 步：浏览器验证

刷新浏览器页面 `http://192.168.100.62:3000`，查看更新是否生效。

---

## 服务管理

### 查看服务状态

```bash
ssh hywl@192.168.100.62
# 输入密码：123

pm2 status agent-master

exit
```

**看到什么**：
```
Status: online  ← 这个表示正常运行
Status: stopped ← 这个表示已停止
Status: errored ← 这个表示出错了
```

---

### 重启服务

**什么时候需要**：
- 网页打不开了
- 网页显示不正常
- 服务器重启后

**怎么做**：

```bash
ssh hywl@192.168.100.62
# 输入密码：123

pm2 restart agent-master

exit
```

---

### 查看日志（找错误）

**什么时候需要**：
- 网页打不开
- 服务状态显示 errored

**怎么做**：

```bash
ssh hywl@192.168.100.62
# 输入密码：123

pm2 logs agent-master --lines 50

# 按 Ctrl+C 退出日志查看

exit
```

---

### 停止服务

```bash
ssh hywl@192.168.100.62
# 输入密码：123

pm2 stop agent-master

exit
```

---

### 启动服务

```bash
ssh hywl@192.168.100.62
# 输入密码：123

pm2 start agent-master

exit
```

---

## 常见问题解决

### ❌ 问题 1：网页打不开（ERR_CONNECTION_REFUSED）

**症状**：浏览器显示"无法访问此网站"

**解决步骤**：

#### 第 1 步：检查服务是否在运行

```bash
ssh hywl@192.168.100.62
# 密码：123

pm2 status agent-master
```

如果显示 `online`，进入第 2 步
如果显示 `stopped` 或 `errored`，执行：

```bash
pm2 restart agent-master
```

#### 第 2 步：检查端口是否监听

```bash
netstat -tlnp | grep 3000
```

如果**没有任何输出**，说明服务没有启动成功，查看日志：

```bash
pm2 logs agent-master --err --lines 30
```

根据错误信息排查。

#### 第 3 步：测试本地访问

在服务器上执行：

```bash
curl -I http://localhost:3000
```

如果返回 `HTTP/1.1 200 OK`，说明服务正常，可能是网络问题。

如果返回错误，重启服务：

```bash
pm2 delete agent-master
pm2 start serve --name agent-master -- current -s
pm2 save
```

---

### ❌ 问题 2：页面显示空白

**症状**：网页能打开，但是一片空白

**解决方法**：

1. 按 `F12` 打开浏览器开发者工具
2. 点击 `Console（控制台）` 标签
3. 看看有没有红色的错误信息
4. 如果有错误，可能是资源加载失败

**重新部署**：

```bash
# 重新构建
cd "/Users/chch/Desktop/agent master"
npm run build
tar -czf dist.tgz -C dist .

# 重新上传部署（使用日常更新部署的步骤）
```

---

### ❌ 问题 3：构建失败

**症状**：执行 `npm run build` 时报错

**常见原因和解决**：

#### 原因 1：依赖包没安装

**解决**：

```bash
cd "/Users/chch/Desktop/agent master"
npm install
```

等待安装完成后，再执行：

```bash
npm run build
```

#### 原因 2：代码有错误

**解决**：
- 检查最近修改的代码
- 查看错误提示信息，定位具体文件和行号
- 修复错误后重新构建

---

### ❌ 问题 4：上传失败（Permission denied）

**症状**：执行 scp 命令时提示权限错误

**解决**：

1. 检查密码是否正确（应该是 `123`）
2. 检查服务器地址是否正确（应该是 `192.168.100.62`）
3. 检查用户名是否正确（应该是 `hywl`）

---

### ❌ 问题 5：PM2 进程频繁重启

**症状**：`pm2 status` 显示 restart 次数很高

**解决步骤**：

1. 查看错误日志：
   ```bash
   ssh hywl@192.168.100.62
   pm2 logs agent-master --err
   ```

2. 如果是端口占用问题，重启服务：
   ```bash
   pm2 delete agent-master
   pm2 start serve --name agent-master -- current -s
   pm2 save
   ```

---

## 附录：完整命令速查表

### 首次部署

```bash
# 1. 上传初始化脚本
cd "/Users/chch/Desktop/agent master" && expect << 'EOF'
spawn scp scripts/server/setup.sh hywl@192.168.100.62:~/
expect "password:"
send "123\r"
expect eof
EOF

# 2. 执行初始化（自动登录并运行）
expect << 'EOF'
spawn ssh hywl@192.168.100.62
expect "password:"
send "123\r"
expect "hywl@"
send "chmod +x ~/setup.sh && ~/setup.sh\r"
expect "hywl@"
send "exit\r"
expect eof
EOF

# 3. 构建项目
cd "/Users/chch/Desktop/agent master" && npm run build

# 4. 打包
tar -czf dist.tgz -C dist .

# 5. 上传
expect << 'EOF'
spawn scp dist.tgz hywl@192.168.100.62:/tmp/
expect "password:"
send "123\r"
expect eof
EOF

# 6. 部署（完整命令在"步骤 8"中）
```

---

### 日常更新

```bash
# 1. 构建和打包
cd "/Users/chch/Desktop/agent master" && npm run build && tar -czf dist.tgz -C dist .

# 2. 上传
expect << 'EOF'
spawn scp dist.tgz hywl@192.168.100.62:/tmp/
expect "password:"
send "123\r"
expect eof
EOF

# 3. 部署（完整命令在"日常更新部署-第3步"中）
```

---

### 服务管理

```bash
# 查看状态
ssh hywl@192.168.100.62
pm2 status agent-master
exit

# 重启服务
ssh hywl@192.168.100.62
pm2 restart agent-master
exit

# 查看日志
ssh hywl@192.168.100.62
pm2 logs agent-master
exit

# 停止服务
ssh hywl@192.168.100.62
pm2 stop agent-master
exit

# 启动服务
ssh hywl@192.168.100.62
pm2 start agent-master
exit
```

---

## 🎯 成功标准

部署成功的判断标准：

✅ PM2 状态显示 `online`
✅ 浏览器能打开 `http://192.168.100.62:3000`
✅ 页面正常显示，功能正常使用
✅ 刷新页面不会出错

---

## 💡 小贴士

### 1. 复制命令的技巧

- **在 Mac 上**：
  - 复制：选中文字后按 `⌘ + C`
  - 粘贴到终端：在终端中按 `⌘ + V`

### 2. 终端快捷键

- **清屏**：`⌘ + K`
- **中断命令**：`Ctrl + C`
- **退出程序**：`Ctrl + D` 或输入 `exit`

### 3. 查看命令是否执行完成

- 如果终端中出现 `$` 或 `%` 符号，说明命令执行完了
- 如果一直在输出文字或进度条，说明还在执行中

### 4. 保存命令历史

建议把常用命令保存到一个文本文件中，下次直接复制使用：

1. 打开"备忘录"或"文本编辑"
2. 把常用命令粘贴进去
3. 保存文件，命名为"部署命令.txt"

---

## 📞 遇到问题怎么办？

### 解决问题的思路

1. **先查看错误信息**
   - 看终端输出的红色错误
   - 看 PM2 日志：`pm2 logs agent-master`

2. **确认基本信息**
   - 服务器地址是否正确？
   - 密码是否正确？
   - 网络是否通畅？

3. **尝试重启**
   - 重启 PM2 服务：`pm2 restart agent-master`
   - 重新部署一次

4. **查看本手册**
   - 在"常见问题解决"章节找解决方法

---

## ✨ 恭喜你！

如果你能成功部署，说明你已经掌握了：

✅ 如何使用终端
✅ 如何连接服务器
✅ 如何构建和部署项目
✅ 如何管理服务器上的服务

这些都是非常有价值的技能！

---

**最后更新时间**：2025-12-10
**适用版本**：Agent Master 所有版本
